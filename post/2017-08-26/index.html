<!DOCTYPE html>
<html class="no-js" lang="en-US" prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#">
<head>
    <meta charset="utf-8">

    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="description" content="">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="keywords" content="热更新, Android, ">

 
<meta property="og:type" content="article"/>
<meta property="og:description" content=""/>
<meta property="og:title" content="Android热更新 : 桂圆的第二人生"/>
<meta property="og:site_name" content="xiaoyuan gui blog"/>
<meta property="og:image" content="" />
<meta property="og:image:type" content="image/jpeg" />
<meta property="og:image:width" content="" />
<meta property="og:image:height" content="" />
<meta property="og:url" content="https://guixiaoyuan.github.io/post/2017-08-26/">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2017-08-26"/>
<meta property="article:modified_time" content="2017-08-26"/>



<meta property="article:tag" content="热更新">
<meta property="article:tag" content="Android">





    <base href="https://guixiaoyuan.github.io/">
    <title> Android热更新 - 桂圆的第二人生 </title>
    <link rel="canonical" href="https://guixiaoyuan.github.io/post/2017-08-26/">
    

    
<link rel="stylesheet" href="/static/css/style.css">

    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
    <script>
	var _hmt = _hmt || [];
	(function() {
	  var hm = document.createElement("script");
	  hm.src = "//hm.baidu.com/hm.js?a79535ca63291dc820e3ecefa615aad1";
	  var s = document.getElementsByTagName("script")[0]; 
	  s.parentNode.insertBefore(hm, s);
	})();
	</script>

</head>

<body lang="en" itemscope itemtype="http://schema.org/Article">
<header id="header">
	<nav id="nav">
	<div id="title"><a href="/">桂圆的第二人生</a></div>
    <div><a href=mailto: 463316523@qq.com target="_blank" class="mailto"> </span> <span class="icon-mail"></span>463316523@qq.com</a></div>
	</nav>
    <nav id="nav">
    	        <ul id="mainnav">
            <li>
                <a href="/蘅芜/">
                <span class="icon"> <i aria-hidden="true" class="icon-pencil"></i></span>
                <span> 蘅芜 </span>
            </a>
            </li>
            <li>
            <a href="/潇湘/">
                <span class="icon"> <i aria-hidden="true" class="icon-quill"></i></span>
                <span> 潇湘 </span>
            </a>
            </li>
            <li>
            <a href="/观叹/">
                <span class="icon"> <i aria-hidden="true" class="icon-leaf"></i></span>
                <span> 观叹 </span>
            </a>
            </li>
            <li>
            <a href="/about">
                <span class="icon"> <i aria-hidden="true" class="icon-heart"></i></span>
                <span> 关于 </span>
            </a>
            </li>
        </ul>

    </nav>
    <nav id="nav">
       	        <ul id="social">
            
            <li id="share">
                <span class="title"> 友链 </span>
                <div class="dropdown share">
                    <ul class="social">
                      
                      <li> <a href="http://spf13.com" target="_blank" title="spf13 is Steve Francis" class="facebook">spf13</a> </li>
                      <li> <a href="http://libaier.net" target="_blank" title="Libaier" class="rss">Libaier</a> </li>
                      <li> <a href="http://www.androidweekly.cn/" target="_blank" title="Android开发周报" class="douban">Android 开发周报</a></li>
                      <li> <a href="http://androidblog.cn/" target="_blank" title="Android blog周刊" class="yangzhe">Android blog周刊</a></li>
                      <li> <a href="http://http://tianwang.gift/" target="_blank" title="Tian" class="tian">Tian</a></li>
                    </ul>
                <span class="icon icon-bubbles"> </span> <span class="subcount"></span> </div>
            </li>
    
            <li id="follow">
                <span class="title"> 驻留地 </span>
                <div class="dropdown follow">
                    <ul class="social">
                        

                        <li> <a href="http://weibo.com/2975201462/profile?topnav=1&wvr=6" target="_blank" title="微博" class="weibo">微博</a> </li>
                        <li> <a href="https://www.zhihu.com/people/gui-xiao-yuan" target="_blank" title="知乎" class="zhihu">知乎</a> </li>
                        <li> <a href="https://github.com/guixiaoyuan" target="_blank" title="GitHub" class="github">GitHub</a> </li>                         
                        
                    </ul>
                <span class="icon icon-rocket"> </span> <span class="subcount"></span> </div>
            </li>

        </ul>

	</nav>
</header>



<section id="main">
  <h1 itemprop="name" >Android热更新</h1>
  

<aside id="meta">

    <div>
        <section id="datecount">
          <h4 id="date"> Sat Aug 26, 2017 </h4>
          
        </section>
        
        <ul id="tags">
          
            <li> <a href="https://guixiaoyuan.github.io//tags/%E7%83%AD%E6%9B%B4%E6%96%B0">热更新</a> </li>
          
            <li> <a href="https://guixiaoyuan.github.io//tags/android">Android</a> </li>
          
        </ul>
    </div>


</aside>

<meta itemprop="wordCount" content="395">
<meta itemprop="datePublished" content="2017-08-26">
<meta itemprop="url" content="https://guixiaoyuan.github.io/post/2017-08-26/">


  <div>
        <article itemprop="articleBody" id="content">
           <p>项目场景：</p>

<ul>
<li>紧急发现了一个bug，影响用户体验，阻断项目流程。这个时候，只能紧急发布一个强制更新的新版本，让用户升级。</li>
<li>最近百团大战开始。需要增加一个活动弹窗入口，越快越好。这个时候，只能紧急发布一个强制更新的新版本，让用户升级。</li>
</ul>

<p>存在需求：</p>

<pre><code>可不可以不让用户重新安装就可以解决上述场景？
</code></pre>

<p></p>

<h3 id="什么是热更新">什么是热更新：</h3>

<pre><code>让应用能够在无需重新安装的情况实现更新，帮助应用快速建立动态修复能力。
</code></pre>

<p>从上面的定义来看，热补丁节省Android大量应用市场发布的时间。同时用户也无需重新安装，只要上线就能无感知的更新。</p>

<h3 id="热更新的原理">热更新的原理：</h3>

<p>现在市面上主流的几大热更新技术：</p>

<ul>
<li>淘宝 Dexposed</li>
<li>支付宝 AndFix</li>
<li>Qzone 超级热补丁</li>
<li>微信 Tinker</li>
</ul>

<h4 id="dexposed">Dexposed</h4>

<p>基于 Xposed 实现的无侵入的运行时 AOP (Aspect-oriented Programming)  框架，可以实现在线修复 Bug，修复粒度方法级别，这也就意味着我们没有办法进行类的增减操作。而且由于对 ART 虚拟机不支持，导致其对 Android 5.0、6.0 均不支持，使用局限性太大。</p>

<h3 id="andfix">AndFix</h3>

<p>native hook 方式，其核心部分在 JNI 层对方法进行替换，替换有问题的方法,修复粒度方法级别，无法在类中新增和删减字段，可以做到即时生效。也就是运行时生效。但是因为它的核心部分在JNI，所以会出现很多适配兼容的问题。因为国内的rom厂商多才多艺.</p>

<h3 id="超级热补丁">超级热补丁</h3>

<p>使用新的 ClassLoader 加载 patch.dex，hack 默认的 ClassLoader，替换有问题的类，修复粒度类级别，一般无法做到即时生效，需要在应用下一次启动时生效。但是在art虚拟机中，如果改变了类变量，和方法名，有可能导致内存错乱的问题，没有开源这个项目。但在github上的Nuwa采用了相同的方式，这个是开源。</p>

<h3 id="tinker">Tinker</h3>

<p>dex 文件全量替换，基于 DexDiff 技术，对比修复前后的 dex 文件，生成 patch.dex，再根据 patch.dex 更新有问题的 dex 文件。简单来说，在编译时通过新旧两个Dex生成差异patch.dex。在运行时，将差异patch.dex重新跟原始安装包的旧Dex还原为新的Dex。这个过程可能比较耗费时间与内存，所以我们是单独放在一个后台进程:patch中。为了补丁包尽量的小，微信自研了DexDiff算法，它深度利用Dex的格式来减少差异的大小。</p>

<h3 id="热更新方案的比较">热更新方案的比较：</h3>

<table>
<thead>
<tr>
<th>Tables</th>
<th align="center">Tinker</th>
<th align="right">Qzone</th>
<th align="center">Andfix</th>
<th align="right">Dexposed</th>
</tr>
</thead>

<tbody>
<tr>
<td>类替换</td>
<td align="center">yes</td>
<td align="right">yes</td>
<td align="center">no</td>
<td align="right">no</td>
</tr>

<tr>
<td>lib替换</td>
<td align="center">yes</td>
<td align="right">no</td>
<td align="center">no</td>
<td align="right">no</td>
</tr>

<tr>
<td>资源替换</td>
<td align="center">yes</td>
<td align="right">yes</td>
<td align="center">no</td>
<td align="right">no</td>
</tr>

<tr>
<td>全平台支持</td>
<td align="center">yes</td>
<td align="right">yes</td>
<td align="center">yes</td>
<td align="right">no</td>
</tr>

<tr>
<td>即时生效</td>
<td align="center">no</td>
<td align="right">no</td>
<td align="center">yes</td>
<td align="right">yes</td>
</tr>

<tr>
<td>性能损耗</td>
<td align="center">较小</td>
<td align="right">较大</td>
<td align="center">较小</td>
<td align="right">较小</td>
</tr>

<tr>
<td>补丁包大小</td>
<td align="center">较小</td>
<td align="right">较大</td>
<td align="center">一般</td>
<td align="right">一般</td>
</tr>

<tr>
<td>开发透明</td>
<td align="center">yes</td>
<td align="right">yes</td>
<td align="center">no</td>
<td align="right">no</td>
</tr>

<tr>
<td>复杂度</td>
<td align="center">较低</td>
<td align="right">较低</td>
<td align="center">复杂</td>
<td align="right">复杂</td>
</tr>

<tr>
<td>gradle支持</td>
<td align="center">yes</td>
<td align="right">yes</td>
<td align="center">no</td>
<td align="right">no</td>
</tr>

<tr>
<td>接口文档</td>
<td align="center">丰富</td>
<td align="right">一般</td>
<td align="center">一般</td>
<td align="right">较少</td>
</tr>

<tr>
<td>占rom体积</td>
<td align="center">较大</td>
<td align="right">较小</td>
<td align="center">较小</td>
<td align="right">较小</td>
</tr>

<tr>
<td>成功率</td>
<td align="center">较好</td>
<td align="right">最高</td>
<td align="center">一般</td>
<td align="right">一般</td>
</tr>
</tbody>
</table>

<h3 id="热更新的使用场景">热更新的使用场景：</h3>

<p>热补丁技术也可以理解为一个动态修改代码与资源的通道，它适合于修改量较少的情况。</p>

<p>我们看一下微信的版本升级的情况：</p>

<table>
<thead>
<tr>
<th>Tables</th>
<th align="center">普通升级</th>
<th align="right">布丁升级</th>
</tr>
</thead>

<tbody>
<tr>
<td>数据大小</td>
<td align="center">33M</td>
<td align="right">145K</td>
</tr>

<tr>
<td>更新速度</td>
<td align="center">10天</td>
<td align="right">1天（70%）</td>
</tr>

<tr>
<td>自动升级</td>
<td align="center">wifi</td>
<td align="right">移动网络</td>
</tr>
</tbody>
</table>

<p>以Android用户的升级习惯，即使是相对活跃的微信也需要10天以上的时间去覆盖50%的用户。使用补丁技术，我们能做到1天覆盖70%以上。这也是基于补丁体积较小，可以直接使用移动网络下载更新。</p>

<h3 id="热更新使用限制">热更新使用限制</h3>

<ul>
<li>补丁只能针对单一客户端版本，随着版本差异变大补丁体积也会增大；</li>
<li>补丁不能支持所有的修改，例如AndroidManifest；</li>
<li>补丁无论对代码还是资源的更新成功率都无法达到100%。</li>
</ul>

<h3 id="如何在一个项目中增加热更新功能">如何在一个项目中增加热更新功能？</h3>

<ul>
<li><p>在工程目录 build.gradle 文件中添加插件依赖。</p>

<pre><code>buildscript {
    repositories {
        jcenter()
    }
    dependencies {
        // tinkersupport插件，其中latest.release指代最新版本号，也可以指定明确的版本号，例如1.0.8
        classpath &quot;com.tencent.bugly:tinker-support:latest.release&quot;
    }
}
</code></pre></li>

<li><p>在app module 下的build.gradle 文件中添加 配置</p>

<pre><code>dependencies {
      compile &quot;com.android.support:multidex:1.0.1&quot; 
      compile 'com.tencent.bugly:crashreport_upgrade:latest.release'
}
// 依赖插件脚本
apply from: 'tinker-support.gradle'
</code></pre></li>

<li><p>在同级目录下创建 tinker-support.gradle</p>

<pre><code>apply plugin: 'com.tencent.bugly.tinker-support'

def bakPath = file(&quot;${buildDir}/bakApk/&quot;)

/**
 * 此处填写每次构建生成的基准包目录
 */
def baseApkDir = &quot;app-0912-17-04-44&quot;
/**
 * 对于插件各参数的详细解析请参考
 */
tinkerSupport {

    // 开启tinker-support插件，默认值true
    enable = true

    //自动生成tinkerId，无须关注此。默认为false
    //autoGenerateTinkerId = true

    tinkerEnable = true

    // 指定归档目录，默认值当前module的子目录tinker
    autoBackupApkDir = &quot;${bakPath}&quot;

    // 是否启用覆盖tinkerPatch配置功能，默认值false
    // 开启后tinkerPatch配置不生效，即无需添加tinkerPatch
    overrideTinkerPatchConfiguration = true

    // 编译补丁包时，必需指定基线版本的apk，默认值为空
    // 如果为空，则表示不是进行补丁包的编译
    // @{link tinkerPatch.oldApk }
    baseApk = &quot;${bakPath}/${baseApkDir}/com.nongfenqi.sherlock-release-v2.3.2_32.apk&quot;
    // 对应tinker插件applyMapping
    baseApkProguardMapping = &quot;${bakPath}/${baseApkDir}/app-release-mapping.txt&quot;

    // 对应tinker插件applyResourceMapping
    baseApkResourceMapping = &quot;${bakPath}/${baseApkDir}/app-release-R.txt&quot;

    // 构建基准包和补丁包都要指定不同的tinkerId，并且必须保证唯一性
    tinkerId = &quot;2.3.2-0912-patch&quot;

    // 构建多渠道补丁时使用
    // buildAllFlavorsDir = &quot;${bakPath}/${baseApkDir}&quot;

    // 是否启用加固模式，默认为false.(tinker-spport 1.0.7起支持）
    // isProtectedApp = true

    // 是否开启反射Application模式
    enableProxyApplication = false

}

/**
 * 一般来说,我们无需对下面的参数做任何的修改
 * 对于各参数的详细介绍请参考:
 * https://github.com/Tencent/tinker/wiki/Tinker-%E6%8E%A5%E5%85%A5%E6%8C%87%E5%8D%97
 */
tinkerPatch {
    //oldApk =&quot;${bakPath}/${appName}/app-release.apk&quot;
    tinkerEnable = true
    ignoreWarning = false
    useSign = true
    dex {
        dexMode = &quot;jar&quot;
        pattern = [&quot;classes*.dex&quot;]
        loader = []
    }
    lib {
        pattern = [&quot;lib/*/*.so&quot;]
    }

    res {
        pattern = [&quot;res/*&quot;, &quot;r/*&quot;, &quot;assets/*&quot;, &quot;resources.arsc&quot;, &quot;AndroidManifest.xml&quot;]
        ignoreChange = []
        largeModSize = 100
    }

    packageConfig {
    }
    sevenZip {
        zipArtifact = &quot;com.tencent.mm:SevenZip:1.1.10&quot;
//        path = &quot;/usr/local/bin/7za&quot;
    }
    buildConfig {
        keepDexApply = false
        //tinkerId = &quot;1.0.1-base&quot;
        //applyMapping = &quot;${bakPath}/${appName}/app-release-mapping.txt&quot; //  可选，设置mapping文件，建议保持旧apk的proguard混淆方式
        //applyResourceMapping = &quot;${bakPath}/${appName}/app-release-R.txt&quot; // 可选，设置R.txt文件，通过旧apk文件保持ResId的分配
    }
}
</code></pre></li>

<li><p>权限配置以及activity配置。</p>

<pre><code>&lt;uses-permission android:name=&quot;android.permission.READ_PHONE_STATE&quot; /&gt;
&lt;uses-permission android:name=&quot;android.permission.INTERNET&quot; /&gt;
&lt;uses-permission android:name=&quot;android.permission.ACCESS_NETWORK_STATE&quot; /&gt;
&lt;uses-permission android:name=&quot;android.permission.ACCESS_WIFI_STATE&quot; /&gt;
&lt;uses-permission android:name=&quot;android.permission.READ_LOGS&quot; /&gt;
&lt;uses-permission android:name=&quot;android.permission.WRITE_EXTERNAL_STORAGE&quot; /&gt;
&lt;uses-permission android:name=&quot;android.permission.READ_EXTERNAL_STORAGE&quot;/&gt;


&lt;activity
    android:name=&quot;com.tencent.bugly.beta.ui.BetaActivity&quot;
    android:theme=&quot;@android:style/Theme.Translucent&quot; /&gt;
</code></pre></li>

<li><p>混淆配置</p></li>
</ul>

<pre><code class="language-js">        -dontwarn com.tencent.bugly.**
        -keep public class com.tencent.bugly.**{*;}
</code></pre>

<hr />
        </article>
  </div>
</section>

<aside id=comments>
    <div><h2> Comments </h2></div>
    <div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "guixiaoyuan" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</aside>

<footer>
  <div>
    <p>
    &copy; 2017 <span itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Xiaoyuan Gui.</span></span>
        Powered by <a href="http://hugo.spf13.com">Hugo</a>.
        Theme by <a href="http://spf13.com">Steve Francia</a>.
    </p>
  </div>
</footer>
<script type="text/javascript">
(function(){var j=function(a,b){return window.getComputedStyle?getComputedStyle(a).getPropertyValue(b):a.currentStyle[b]};var k=function(a,b,c){if(a.addEventListener)a.addEventListener(b,c,false);else a.attachEvent('on'+b,c)};var l=function(a,b){for(key in b)if(b.hasOwnProperty(key))a[key]=b[key];return a};window.fitText=function(d,e,f){var g=l({'minFontSize':-1/0,'maxFontSize':1/0},f);var h=function(a){var b=e||1;var c=function(){a.style.fontSize=Math.max(Math.min(a.clientWidth/(b*10),parseFloat(g.maxFontSize)),parseFloat(g.minFontSize))+'px'};c();k(window,'resize',c)};if(d.length)for(var i=0;i<d.length;i++)h(d[i]);else h(d);return d}})();
fitText(document.getElementById('title'), 1)
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    // Fix <code> tags after MathJax finishes running. This is a
    // hack to overcome a shortcoming of Markdown. Discussion at
    // https://github.com/mojombo/jekyll/issues/199
    var all = MathJax.Hub.getAllJax(), i;
    for(i = 0; i &lt; all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
});
</script>

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/default.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

</body>
</html>


<script type="text/javascript"
  src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\[','\]']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] }
  }
});
</script>

</body>
